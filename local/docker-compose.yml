version: '3.9'

services:
  redis:
    image: redis:latest
    container_name: redis_server
    ports:
      - "6379:6379"

  pubsub_emulator:
    image: google/cloud-sdk:latest
    container_name: pubsub_emulator
    entrypoint: ["gcloud", "beta", "emulators", "pubsub", "start", "--project=local-project", "--host-port=0.0.0.0:8085"]
    environment:
      PUBSUB_PROJECT_ID: local-project
      PUBSUB_EMULATOR_HOST: pubsub_emulator:8085
    ports:
      - "8085:8085"

  fastapi:
    build:
      context: ..
      dockerfile: local/Dockerfile
    container_name: fastapi_server
    ports:
      - "8080:8080"
      - "5678:5678"
    volumes:
      - ../app:/code/app
    env_file:
      - path: "../.env.local"
        required: true
    depends_on:
      - redis
      - pubsub_emulator
